var CcdcWidget;!function(t){var s=(c.prototype.initialise=function(t,e,i){var n=this;this.renderDefaultLoadingScreen(),console.log("Loading CcdcWidget "+c.version),this.widgetLocation=t,this.jsmolLibraryLocation=e,this.serviceLocation=i,this.loadDependencies(function(){console.log("Loaded CcdcWidget: Dependencies Loaded"),n.parseMarkup()})},c.prototype.renderDefaultLoadingScreen=function(){var t="div.ccdc-widget";if(0==$(t).length)return console.log("Cant find widget div"),void c.addErrorPanel(0);console.log("Rendering loading screen"),$(t).each(function(t){void 0!==$(this).attr("data-ccdc-widget-doi")?$(this).parent().append('<div class="ccdc-widget-'+t+'-loading-pane" style="text-align: center"><p><img src="https://cdn.ccdc.cam.ac.uk/content/images/ccdc-branding-logo-strapline.svg" alt="CCDC Logo" style="width: 200px" /></p><p>Loading Widget...</p></div>'):c.addErrorPanel(t)})},c.prototype.loadDependencies=function(t){var e,i,n,s=this,c=[s.widgetLocation+"CcdcJsmolUtilities.min.js",s.jsmolLibraryLocation+this.jsmolVersion+"/JSmol.min.nojq.js"];i=t,n=0,(e=c).forEach(function(t){$.getScript(t,function(){++n===e.length&&i()})}),$.each(["CcdcWidget.min.css"],function(t,e){$("<link>").appendTo("head").attr("type","text/css").attr("rel","stylesheet").attr("href",s.widgetLocation+e)})},c.prototype.parseMarkup=function(){var s=this;$("[data-ccdc-widget-doi]").each(function(t,e){var i=[],n=$(e).data();$.each(n,function(t,e){i[t.replace("ccdcWidget","").toLowerCase()]=e}),console.log("each DOI with index: "+t),s.createWidget(e,i,t)})},c.prototype.createWidget=function(t,e,i){try{console.log("createWidget:"+i),this.widgets.push(new n(this.widgetLocation,this.jsmolLibraryLocation,this.serviceLocation,t,e,i))}catch(t){console.log("createWidget exception:"+i),c.handleError(i,t)}},c.handleError=function(t,e){console.log("CCDC CSD 3D Widget Error ("+e.code+") "+e.message),c.addErrorPanel(t)},c.addErrorPanel=function(t){var e='<div class="ccdc-widget-'+t+'-error-panel" style="text-align: center"><p><img src="https://cdn.ccdc.cam.ac.uk/content/images/ccdc-branding-logo-strapline.svg" alt="CCDC Logo" style="width: 200px" /></p><p>No structures are currently available to view but they are available from the CCDC website <a href="https://www.ccdc.cam.ac.uk/structures" target="_blank">www.ccdc.cam.ac.uk/structures</a></p></div>',i=$(".ccdc-widget-"+t+"-loading-pane");if(i.is(":visible"))return i.after(e),void i.hide();var n=$("div.ccdc-widget").eq(t);n.is(":visible"),n.after(e)},c.version="1.0.0.1",c);function c(){this.jsmolVersion="14.2.7",this.widgets=[]}t.App=s;var n=(e.prototype.loadDefaultSettings=function(e){var i={width:"100%",height:372,style:"ballandstick",labels:"none",packing:"none",measure:"none",hydrogens:"on",spinning:"on",disorder:"on"};return $.each(i,function(t){e.hasOwnProperty(t)||(e[t]=i[t])}),e},e.prototype.setContainer=function(t){t.id=this.containerId,this.$container=$(t),this.$container.addClass("ccdc-widget").css("width",this.settings.width).css({"min-height":this.settings.height+"px"}).hide()},e.prototype.setReferences=function(){this.$jsmolWrapper=this.getJqElement("viewer-wrapper"),this.$styleSelector=this.getJqElement("style-selector"),this.$labelsSelector=this.getJqElement("labels-selector"),this.$packingSelector=this.getJqElement("packing-selector"),this.$measureSelector=this.getJqElement("measure-selector"),this.$btnSpin=this.getJqElement("btn-spin"),this.$btnH=this.getJqElement("btn-h"),this.$btnDisorder=this.getJqElement("btn-disorder"),this.$btnMenu=this.getJqElement("btn-menu"),this.$btnNext=this.getJqElement("btn-next"),this.$btnPrev=this.getJqElement("btn-prev"),this.$btnMore=this.getJqElement("btn-more"),this.$btnDownload=this.getJqElement("btn-download"),this.$loadingPane=$("."+this.prefix+this.instanceIndex+"-loading-pane")},e.prototype.getJqElement=function(t){return this.$container.find("."+this.prefix+t)},e.prototype.getSelectorValue=function(t){return t.find("option:selected").val()},e.prototype.applySettings=function(){this.$styleSelector.find('option[value="'+this.settings.style+'"]').prop("selected",!0),this.$labelsSelector.find('option[value="'+this.settings.labels+'"]').prop("selected",!0),this.$packingSelector.find('option[value="'+this.settings.packing+'"]').prop("selected",!0),this.$measureSelector.find('option[value="'+this.settings.measure+'"]').prop("selected",!0),this.$container.find("."+this.prefix+"viewer-container").css({height:this.settings.height+"px"}),"on"===this.settings.spinning?this.$btnSpin.addClass("active"):this.$btnSpin.removeClass("active"),"on"===this.settings.hydrogens?this.$btnH.addClass("active"):this.$btnH.removeClass("active"),"on"===this.settings.disorder?this.$btnDisorder.addClass("active"):this.$btnDisorder.removeClass("active")},e.prototype.decodeMolData=function(t){for(var e=0;e<t.length;e++)t[e].mol2_file=Ccdc.JsmolUtilities.base64Decode(t[e].mol2_file);return t},e.prototype.setWidth=function(){var t=this.$container.width();this.$container.removeClass(this.prefix+"xs "+this.prefix+"sm"),t<360?this.$container.addClass(this.prefix+"xs"):t<400&&this.$container.addClass(this.prefix+"sm")},e.prototype.loadMolFile=function(t){var e=this.serviceResultData[t],i=e.ccdc_number;Ccdc.JsmolUtilities.loadData(e.mol2_file,e.structureFileType,this.appletIdentifier),Ccdc.JsmolUtilities.runScript('set echo 50% 95%; color echo white; font echo 14 Arial bold;echo "CCDC Number: '+i+'";',this.appletIdentifier),this.getJqElement("viewer-message").hide()},e.prototype.applyElementStates=function(){var t={style:this.getSelectorValue(this.$styleSelector),labels:this.getSelectorValue(this.$labelsSelector),hydrogens:this.getButtonValue(this.$btnH),disorder:{symmetry:this.getSelectorValue(this.$packingSelector),val:this.getButtonValue(this.$btnDisorder)},spacegroup:this.serviceResultData[this.currentStructureIndex].spacegroup_operators,spin:this.getButtonValue(this.$btnSpin)};Ccdc.JsmolUtilities.applyStates(t,this.appletIdentifier)},e.prototype.bindEvents=function(){var n=this,s=this;s.$btnMenu.off("click").on("click",function(){Ccdc.JsmolUtilities.runScript("menu",n.appletIdentifier)}),s.$btnPrev.off("click").on("click",function(){0<s.currentStructureIndex&&s.currentStructureIndex--,s.loadMolFile(s.currentStructureIndex),s.applyElementStates(),s.updateStructureCounter()}),s.$btnNext.off("click").on("click",function(){s.currentStructureIndex<s.serviceResultData.length-1&&s.currentStructureIndex++,s.loadMolFile(s.currentStructureIndex),s.applyElementStates(),s.updateStructureCounter()}),s.$btnSpin.off("click").on("click",function(){s.$btnSpin.toggleClass("active"),Ccdc.JsmolUtilities.spin(s.getButtonValue(s.$btnSpin),n.appletIdentifier)}),s.$btnH.off("click").on("click",function(){s.$btnH.toggleClass("active"),Ccdc.JsmolUtilities.showHydrogens(s.getButtonValue(s.$btnH),n.appletIdentifier)}),s.$btnDisorder.off("click").on("click",function(){s.$btnDisorder.toggleClass("active"),Ccdc.JsmolUtilities.showDisorder(s.getButtonValue(s.$btnDisorder),n.appletIdentifier)}),s.$btnMore.off("click").on("click",function(){s.moreAction()}),s.$btnDownload.off("click").on("click",function(){s.moreAction()}),s.$styleSelector.off("change").on("change",function(){var t=s.$styleSelector.val(),e=Ccdc.JsmolUtilities.JsmolStyle[t];Ccdc.JsmolUtilities.setStyle(e,n.appletIdentifier)}),s.$labelsSelector.off("change").on("change",function(){var t=s.$labelsSelector.val(),e=Ccdc.JsmolUtilities.JsmolLabels[t];Ccdc.JsmolUtilities.setLabels(e,n.appletIdentifier)}),s.$packingSelector.off("change").on("change",function(){var t=n.serviceResultData[s.currentStructureIndex],e=s.$packingSelector.val(),i=Ccdc.JsmolUtilities.JsmolSymmetry[e];Ccdc.JsmolUtilities.setSymmetry(i,n.appletIdentifier,t.spacegroup_operators),Ccdc.JsmolUtilities.setStyle(Ccdc.JsmolUtilities.currentStyle,n.appletIdentifier),Ccdc.JsmolUtilities.spin(Ccdc.JsmolUtilities.isSpinning,n.appletIdentifier),Ccdc.JsmolUtilities.setLabels(Ccdc.JsmolUtilities.currentLabels,n.appletIdentifier)}),s.$measureSelector.off("change").on("change",function(){var t=s.$measureSelector.val(),e=Ccdc.JsmolUtilities.JsmolMeasurement[t];Ccdc.JsmolUtilities.setMeasurement(e,n.appletIdentifier)})},e.prototype.moreAction=function(){window.open("https://summary.ccdc.cam.ac.uk/structure-summary?id=doi:"+this.settings.doi+"&ccdc:"+this.serviceResultData[this.currentStructureIndex].ccdc_number)},e.prototype.getButtonValue=function(t){return t.hasClass("active")},e.prototype.updateStructureCounter=function(){this.getJqElement("structure-count").text(this.serviceResultData.length),this.getJqElement("structure-index").text(this.currentStructureIndex+1)},e.prototype.loadServiceData=function(n){var i=this;console.log("Getting Data from service"),$.ajax({url:""+this.serviceLocation+this.settings.doi,type:"GET",dataType:"json",timeout:6e4,cache:!0}).then(function(e){if(e.length){try{for(var t=0;t<e.length;t++)e[t].mol2_file=atob(e[t].mol2_file);i.serviceResultData=e}catch(t){console.log("Cant decode MOL, trying a different way"),i.serviceResultData=i.decodeMolData(e)}i.$container.show(),i.setWidth(),Ccdc.JsmolUtilities.initialise(i.$jsmolWrapper,i.jsmolLocation,i.instanceIndex),i.loadMolFile(0),i.applyElementStates(),i.bindEvents(),i.updateStructureCounter(),i.$loadingPane.hide()}else s.handleError(n,{code:"NO_RESULTS",message:"No matching structures found"})}).fail(function(t,e,i){"timeout"===e?s.handleError(n,{code:"TIMEOUT",message:"An error occurred during loading structures"}):"error"===e&&s.handleError(n,{code:"SERVICE_DOWN",message:"An error occurred during contacting the service"})})},e);function e(t,e,i,n,s,c){var o=this;if(this.currentStructureIndex=0,this.prefix="ccdc-widget-",this.instanceIndex=c,this.appletIdentifier="jsmolApplet"+this.instanceIndex,this.containerId=this.prefix+"container-"+c,this.serviceLocation=i,this.widgetLocation=t,this.jsmolLocation=e,this.settings=this.loadDefaultSettings(s||[]),!this.settings.hasOwnProperty("doi")||""===this.settings.doi)throw{code:"EMPTY_DOI",message:"The DOI cannot be empty"};this.setContainer(n),this.$container.load(t+"CcdcWidget.html",function(){o.setReferences(),o.applySettings(),o.loadServiceData(c)})}}(CcdcWidget=CcdcWidget||{}),$(function(){(new CcdcWidget.App).initialise("https://common.ccdc.cam.ac.uk/ccdc-widget/1.0.0.76/","https://common.ccdc.cam.ac.uk/jsmol/","https://www.ccdc.cam.ac.uk/structures/Data/MolByDoi/")});